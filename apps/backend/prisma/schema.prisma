// apps/backend/prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

// ==========================================
//  ENUMS
// ==========================================

enum Tier {
  FREE
  PREMIUM_MONTHLY
  PREMIUM_YEARLY
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
}

enum ActionStatus {
  PENDING
  SUCCESS
  FAILED
}

enum UserRole {
  USER
  ADMIN
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
  CANCELLED
}

enum ResourceType {
  VIDEO
  ARTICLE
  BOOK
  COURSE
  DOCUMENT
  WEBSITE
  PODCAST
  OTHER
}

enum InteractionType {
  RESOURCE_CLICK
  RESOURCE_VIEW
  RESOURCE_BOOKMARK
  RESOURCE_FEEDBACK
  COURSE_VIEW
  NOTE_CREATE
  NOTE_UPDATE
  GOAL_CREATE
  GOAL_UPDATE
  SCHEDULE_CREATE
  SCHEDULE_UPDATE
  CHAT_MESSAGE
  RECOMMENDATION_REQUESTED
  RECOMMENDATION_ACCEPTED
  RECOMMENDATION_REJECTED
}

// ==========================================
//  USER & AUTH
// ==========================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String? // Nullable for OAuth users
  name         String?
  provider     String? // "google", "email"
  providerId   String?
  tier         Tier     @default(FREE)
  role         UserRole @default(USER)
  isActive     Boolean  @default(true)
  isOnboarded  Boolean  @default(false)

  verificationCode          String? // Stores the 6-digit OTP
  verificationCodeExpiresAt DateTime? // Stores when it expires
  passwordResetCode         String?
  passwordResetExpiresAt    DateTime?

  // Stripe subscription fields
  stripeCustomerId               String?   @unique
  stripeSubscriptionId           String?   @unique
  stripeSubscriptionStatus       String?
  stripePriceId                  String?
  subscriptionCurrentPeriodStart DateTime?
  subscriptionCurrentPeriodEnd   DateTime?

  // Credit tracking for subscription limits
  creditsUsed        Int       @default(0) // Credits consumed in current period
  creditsPeriodStart DateTime? // When current credit period started
  creditsPeriodEnd   DateTime? // When current credit period ends
  creditsSoftCap     Int? // Soft cap (warning threshold) - null means no soft cap
  creditsHardCap     Int? // Hard cap (blocking threshold) - null means no hard cap

  // Daily credit tracking (for FREE tier)
  creditsUsedToday  Int       @default(0) // Credits consumed today
  creditsDailyLimit Int? // Daily limit (only for FREE tier)
  lastDailyReset    DateTime? // When daily credits were last reset

  // Google Calendar integration
  googleCalendarAccessToken  String? // Encrypted access token for Google Calendar API
  googleCalendarRefreshToken String? // Encrypted refresh token for Google Calendar API
  googleCalendarTokenExpiresAt DateTime? // When the access token expires
  googleCalendarSyncEnabled Boolean @default(false) // Whether Calendar sync is enabled
  googleCalendarId String? // Primary calendar ID (usually "primary")

  // Relations
  preferences             UserPreferences?
  courses                 Course[]
  notes                   Note[]
  resources               Resource[]
  goals                   Goal[]
  schedules               ScheduleBlock[]
  userInteractionMemories UserInteractionMemory[]

  // NEW: Chat Relations
  chatSessions ChatSession[]
  chatMessages ChatMessage[] // Direct relation to help count usage (e.g., "50 messages/month")

  // Analytics Relations
  studySessions StudySession[]
  userStreak    UserStreak?
  achievements  Achievement[]

  // Feedback Relations
  feedback Feedback[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserPreferences {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  theme         String  @default("light")
  language      String  @default("en")
  notifications Boolean @default(true)
  studyGoals    Json?
}

// ==========================================
//  COURSES MODULE
// ==========================================

model Course {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title         String
  description   String?
  difficulty    Difficulty @default(BEGINNER)
  targetDate    DateTime?
  isAIGenerated Boolean    @default(false)
  archived      Boolean    @default(false)

  // Cached progress (0.0 to 100.0)
  progress Float @default(0.0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  modules   Module[]
  notes     Note[]
  resources Resource[] // Resources linked to this course
  goals     Goal[] // Goals linked to this course
  schedules ScheduleBlock[] // Schedule blocks linked to this course
  studySessions StudySession[] // Study sessions for this course

  @@index([userId])
  @@index([userId, archived])
}

model Module {
  id       String @id @default(cuid())
  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  title       String
  description String?
  order       Float   @default(0)
  completed   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  topics Topic[]

  @@index([courseId])
  @@index([courseId, order])
}

model Topic {
  id       String @id @default(cuid())
  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  title          String
  content        String? // Markdown content
  order          Float   @default(0)
  completed      Boolean @default(false)
  estimatedHours Float?

  note      Note?
  resources Resource[] // Resources linked to this topic
  goals     Goal[] // Goals linked to this topic
  schedules ScheduleBlock[] // Schedule blocks linked to this topic
  studySessions StudySession[] // Study sessions for this topic

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([moduleId])
  @@index([moduleId, order])
}

// ==========================================
//  CHAT & AI MODULE (NEW)
// ==========================================

model ChatSession {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title    String? // Auto-generated summary (e.g. "Biology Study Plan")
  isActive Boolean @default(true) // False if archived/deleted

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages ChatMessage[]

  @@index([userId])
  @@index([updatedAt]) // Useful for sorting "Recent Chats"
}

model ChatMessage {
  id String @id @default(cuid())

  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  role    ChatRole // USER, ASSISTANT, SYSTEM
  content String // The Markdown text response

  // Voice features
  audioUrl String? // S3 URL if this was a voice message
  duration Float? // Duration in seconds

  // Usage tracking (Critical for Free Tier limits)
  tokenCount Int @default(0)

  createdAt DateTime @default(now())

  // Relations
  actions AIActionLog[]

  @@index([sessionId])
  @@index([userId]) // Helps count "messages this month" quickly
}

model AIActionLog {
  id String @id @default(cuid())

  messageId String
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  actionType String // e.g., "create_course", "create_goal"
  actionData Json // The actual JSON payload used
  status     ActionStatus @default(PENDING)
  error      String? // If status == FAILED

  createdAt DateTime @default(now())

  @@index([messageId])
}

// ==========================================
//  NOTES MODULE
// ==========================================

model Note {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title   String
  content String? // Rich text content
  summary String? // AI generated summary

  courseId String?
  course   Course? @relation(fields: [courseId], references: [id]) // Optional link to course

  topicId String? @unique
  topic   Topic?  @relation(fields: [topicId], references: [id]) // Optional link to topic

  archived          Boolean @default(false)
  voiceRecordingUrl String?

  tags        NoteTag[]
  attachments NoteAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([courseId])
  @@index([topicId])
  @@index([userId, archived])
}

model NoteTag {
  id     String @id @default(cuid())
  noteId String
  note   Note   @relation(fields: [noteId], references: [id], onDelete: Cascade)
  tag    String

  @@index([noteId])
  @@index([tag])
}

model NoteAttachment {
  id       String @id @default(cuid())
  noteId   String
  note     Note   @relation(fields: [noteId], references: [id], onDelete: Cascade)
  filename String
  url      String
  size     Int?

  createdAt DateTime @default(now())

  @@index([noteId])
}

// ==========================================
//  RESOURCES MODULE
// ==========================================

model Resource {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  url         String
  description String?
  type        ResourceType @default(OTHER)
  metadata    Json? // Additional metadata (author, duration, etc.)

  // Recommendation fields
  isRecommended        Boolean @default(false)
  recommendationScore  Float? // Score from 0.0 to 1.0
  recommendationSource String? // "ai", "manual", "similarity"
  recommendationReason String? // Why this resource was recommended (e.g., "for topic X", "related to course Y")

  // Optional links to courses/topics (why this resource is relevant)
  courseId String?
  course   Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)
  topicId  String?
  topic    Topic?  @relation(fields: [topicId], references: [id], onDelete: SetNull)

  // User interaction tracking
  clickCount     Int       @default(0)
  bookmarkCount  Int       @default(0)
  lastAccessedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  embeddings Embedding[]

  @@index([userId])
  @@index([userId, isRecommended])
  @@index([type])
  @@index([courseId])
  @@index([topicId])
}

// ==========================================
//  GOALS MODULE
// ==========================================

model Goal {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String?
  targetDate  DateTime?
  status      GoalStatus @default(ACTIVE)
  progress    Float      @default(0.0) // Progress from 0.0 to 100.0

  // Optional links to courses/topics (for context-aware goals)
  courseId String?
  course   Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)
  topicId  String?
  topic    Topic?  @relation(fields: [topicId], references: [id], onDelete: SetNull)

  schedules ScheduleBlock[] // Schedule blocks linked to this goal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, status])
  @@index([targetDate])
  @@index([courseId])
  @@index([topicId])
}

// ==========================================
//  SCHEDULE MODULE
// ==========================================

model ScheduleBlock {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title         String
  description   String?
  startAt       DateTime
  endAt         DateTime
  recurringRule String? // e.g., "RRULE:FREQ=WEEKLY;BYDAY=MO,WE,FR" or "DAILY", "WEEKLY", etc.
  
  // Google Calendar sync
  googleCalendarEventId String? // ID of the event in Google Calendar
  googleCalendarSyncedAt DateTime? // When this was last synced to Google Calendar

  // Optional links to courses/topics/goals
  courseId String?
  course   Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)
  topicId  String?
  topic    Topic?  @relation(fields: [topicId], references: [id], onDelete: SetNull)
  goalId   String?
  goal     Goal?   @relation(fields: [goalId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, startAt])
  @@index([startAt, endAt])
  @@index([courseId])
  @@index([topicId])
  @@index([goalId])
}

model Embedding {
  id String @id @default(cuid())

  // Object reference (polymorphic)
  objectType String // "resource", "note", "course", "topic"
  objectId   String // ID of the resource/note/course/topic

  // Vector embedding (stored as JSON array, will be converted to pgvector)
  // Using String for now - will need pgvector extension for proper vector type
  vector Json // Array of floats representing the embedding vector

  // Content that was embedded (for debugging/re-indexing)
  content  String? // The text content that was embedded
  metadata Json? // Additional metadata about the embedding

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  resourceId String?
  resource   Resource? @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([objectType, objectId])
  @@index([resourceId])
}

// ==========================================
//  USER MEMORY & PERSONALIZATION MODULE
// ==========================================

model UserInteractionMemory {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  interactionType InteractionType
  entityType      String // "resource", "course", "note", "goal", "chat"
  entityId        String? // ID of the entity interacted with

  // Interaction details
  metadata   Json? // Additional context (e.g., search query, time spent, feedback score)
  importance Float @default(0.5) // 0.0 to 1.0 - how important this interaction is for personalization

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, interactionType])
  @@index([userId, createdAt])
  @@index([entityType, entityId])
}

// ==========================================
//  ANALYTICS MODULE
// ==========================================

model StudySession {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session details
  startTime DateTime
  endTime   DateTime?
  duration  Float // Duration in minutes (calculated when session ends)

  // Context (what was studied)
  courseId String?
  course   Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)
  topicId  String?
  topic    Topic?  @relation(fields: [topicId], references: [id], onDelete: SetNull)

  // Metadata
  metadata Json? // Additional context (device, location, etc.)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, startTime])
  @@index([courseId])
  @@index([topicId])
  @@index([startTime])
}

model UserStreak {
  id String @id @default(cuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Streak tracking
  currentStreak Int @default(0) // Current consecutive days
  longestStreak Int @default(0) // Longest streak ever achieved
  lastStudyDate DateTime? // Last date user studied (for streak calculation)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

enum AchievementType {
  STUDY_TIME_MILESTONE // e.g., "Studied 100 hours"
  STREAK_MILESTONE     // e.g., "7 day streak"
  COURSE_COMPLETION    // e.g., "Completed first course"
  GOAL_ACHIEVEMENT     // e.g., "Completed 10 goals"
  TOPIC_COMPLETION     // e.g., "Completed 50 topics"
  AI_USAGE             // e.g., "Sent 100 AI messages"
}

model Achievement {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  achievementType AchievementType
  title           String // e.g., "7 Day Streak"
  description     String? // e.g., "You've studied for 7 consecutive days!"
  icon            String? // Icon identifier or emoji
  metadata        Json? // Additional data (e.g., milestone value)

  unlockedAt DateTime @default(now())

  @@index([userId])
  @@index([userId, achievementType])
  @@index([unlockedAt])
}

// ==========================================
//  FEEDBACK MODULE
// ==========================================

enum FeedbackType {
  BUG_REPORT
  FEATURE_REQUEST
  GENERAL_FEEDBACK
  UI_UX_FEEDBACK
  PERFORMANCE_ISSUE
  OTHER
}

enum FeedbackStatus {
  PENDING
  REVIEWED
  RESOLVED
  ARCHIVED
}

model Feedback {
  id String @id @default(cuid())

  userId String?
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Feedback content
  type        FeedbackType
  title       String
  description String
  status      FeedbackStatus @default(PENDING)

  // Optional context
  pageUrl     String? // URL where feedback was submitted from
  userAgent   String? // Browser/device info
  metadata    Json?   // Additional context (e.g., screenshots, logs)

  // Admin response
  adminNotes  String?
  resolvedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}