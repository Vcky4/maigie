// apps/backend/prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

enum Tier {
  FREE
  PREMIUM_MONTHLY
  PREMIUM_YEARLY
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String?   // Nullable for OAuth users
  name          String?
  provider      String?   // "google", "email"
  providerId    String?
  tier          Tier      @default(FREE)
  isActive      Boolean   @default(true)
  isOnboarded   Boolean   @default(false)
  verificationCode          String?   // Stores the 6-digit OTP
  verificationCodeExpiresAt DateTime? // Stores when it expires
  passwordResetCode        String?
  passwordResetExpiresAt   DateTime?
  
  // Stripe subscription fields
  stripeCustomerId      String?   @unique
  stripeSubscriptionId  String?   @unique
  stripeSubscriptionStatus String? // active, canceled, past_due, trialing, etc.
  stripePriceId         String?   // The price ID they subscribed to
  subscriptionCurrentPeriodStart DateTime?
  subscriptionCurrentPeriodEnd   DateTime?
  
  // Relation: One User has One set of Preferences
  // (We changed this from 'Json?' to a relation)
  preferences   UserPreferences?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  // c
  courses        Course[]
}

model UserPreferences {
  id            String    @id @default(uuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  theme         String    @default("light") // light/dark
  language      String    @default("en")
  notifications Boolean   @default(true)
  studyGoals    Json?     // Flexible JSON for specific onboarding data
}


// ==========================================
//  COURSES MODULE
// ==========================================

model Course {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title         String
  description   String?
  difficulty    String    @default("Beginner") // Beginner, Intermediate, Advanced
  targetDate    DateTime?
  isAIGenerated Boolean   @default(false)
  archived      Boolean   @default(false)
  
  // Cached progress (0.0 to 100.0) to allow fast sorting/filtering without heavy calculation
  progress      Float     @default(0.0) 
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  modules       Module[]

  @@index([userId])
}

model Module {
  id          String   @id @default(cuid())
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  order       Int      @default(0) // Used for drag-and-drop ordering
  completed   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  topics      Topic[]

  @@index([courseId])
}

model Topic {
  id             String   @id @default(cuid())
  moduleId       String
  module         Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  title          String
  content        String?  // Stores Markdown content or JSON from AI
  order          Int      @default(0)
  completed      Boolean  @default(false)
  estimatedHours Float?   // Optional time tracking
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([moduleId])
}