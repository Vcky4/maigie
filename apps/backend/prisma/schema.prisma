// apps/backend/prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

enum Tier {
  FREE
  PREMIUM_MONTHLY
  PREMIUM_YEARLY
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String?   // Nullable for OAuth users
  name          String?
  provider      String?   // "google", "email"
  providerId    String?
  tier          Tier      @default(FREE)
  isActive      Boolean   @default(true)
  isOnboarded   Boolean   @default(false)
  verificationCode          String?   // Stores the 6-digit OTP
  verificationCodeExpiresAt DateTime? // Stores when it expires
  passwordResetCode        String?
  passwordResetExpiresAt   DateTime?
  
  // Stripe subscription fields
  stripeCustomerId      String?   @unique
  stripeSubscriptionId  String?   @unique
  stripeSubscriptionStatus String? // active, canceled, past_due, trialing, etc.
  stripePriceId         String?   // The price ID they subscribed to
  subscriptionCurrentPeriodStart DateTime?
  subscriptionCurrentPeriodEnd   DateTime?
  
  // Relation: One User has One set of Preferences
  // (We changed this from 'Json?' to a relation)
  preferences   UserPreferences?
  
  // Relations
  courses       Course[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model UserPreferences {
  id            String    @id @default(uuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  theme         String    @default("light") // light/dark
  language      String    @default("en")
  notifications Boolean   @default(true)
  studyGoals    Json?     // Flexible JSON for specific onboarding data
}

// --- Courses Module ---

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

model Course {
  id            String      @id @default(uuid())
  userId        String
  title         String
  description   String?
  difficulty    Difficulty?
  targetDate    DateTime?
  isAIGenerated Boolean     @default(false)
  archived      Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  modules       Module[]
  
  // Indexes for performance
  @@index([userId])
  @@index([userId, archived])
  @@index([userId, isAIGenerated])
}

model Module {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  order       Float    // Float type for efficient drag-and-drop reordering
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  topics      Topic[]
  
  // Indexes for performance
  @@index([courseId])
  @@index([courseId, order])
}

model Topic {
  id             String   @id @default(uuid())
  moduleId       String
  title          String
  order          Float    // Float type for efficient drag-and-drop reordering
  content        String?
  completed      Boolean  @default(false)
  estimatedHours Float?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  module         Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  // Indexes for performance
  @@index([moduleId])
  @@index([moduleId, order])
  @@index([moduleId, completed])
}