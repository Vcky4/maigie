// apps/backend/prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

enum Tier {
  FREE
  PREMIUM_MONTHLY
  PREMIUM_YEARLY
}

// Added this to support the Difficulty field safely
enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String?   // Nullable for OAuth users
  name          String?
  provider      String?   // "google", "email"
  providerId    String?
  tier          Tier      @default(FREE)
  isActive      Boolean   @default(true)
  isOnboarded   Boolean   @default(false)
  
  verificationCode          String?   // Stores the 6-digit OTP
  verificationCodeExpiresAt DateTime? // Stores when it expires
  passwordResetCode         String?
  passwordResetExpiresAt    DateTime?
  
  // Stripe subscription fields
  stripeCustomerId               String?   @unique
  stripeSubscriptionId           String?   @unique
  stripeSubscriptionStatus       String? 
  stripePriceId                  String?   
  subscriptionCurrentPeriodStart DateTime?
  subscriptionCurrentPeriodEnd   DateTime?
  
  // Relations
  preferences   UserPreferences?
  courses       Course[] // Defined only ONCE here

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model UserPreferences {
  id            String    @id @default(uuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  theme         String    @default("light") 
  language      String    @default("en")
  notifications Boolean   @default(true)
  studyGoals    Json?     
}

// ==========================================
//  COURSES MODULE
// ==========================================

model Course {
  id            String      @id @default(cuid()) // Consistent ID style
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title         String
  description   String?
  difficulty    Difficulty  @default(BEGINNER) // Using your Enum
  targetDate    DateTime?
  isAIGenerated Boolean     @default(false)
  archived      Boolean     @default(false)
  
  // Cached progress (0.0 to 100.0) - CRITICAL for performance
  progress      Float       @default(0.0) 
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  modules       Module[]

  @@index([userId])
  @@index([userId, archived]) // Valid composite index
}

model Module {
  id          String   @id @default(cuid())
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  order       Float    @default(0) // Float allows easier drag-and-drop
  
  // We usually track completion at the module level too for UI speed
  completed   Boolean  @default(false) 
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  topics      Topic[]

  @@index([courseId])
  @@index([courseId, order])
}

model Topic {
  id             String   @id @default(cuid())
  moduleId       String
  module         Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  title          String
  content        String?  // Markdown content
  order          Float    @default(0)
  completed      Boolean  @default(false)
  estimatedHours Float?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([moduleId])
  @@index([moduleId, order])
}